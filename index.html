<div id="africaMap">
  <svg id="africaSvg" aria-label="Africa map"></svg>

  <!-- Card stays inside the same container (no page overlay) -->
  <div id="africaCard" role="dialog" aria-label="Country details">
    <div class="cardHead">
      <div id="africaCardTitle">Country</div>
      <button id="africaCardClose" type="button" aria-label="Close">×</button>
    </div>
    <div class="cardGrid">
      <div class="stat"><div class="lbl">Population</div><div class="val" id="popVal">—</div></div>
      <div class="stat"><div class="lbl">2050 Projection</div><div class="val" id="projVal">—</div></div>
      <div class="stat"><div class="lbl">Universities</div><div class="val" id="uniVal">—</div></div>
      <div class="stat"><div class="lbl">Youth %</div><div class="val" id="youthVal">—</div></div>
    </div>
  </div>
</div>

<style>
  /* Single embed block styling (edit to match ASU theme) */
  #africaMap{
    position: relative;
    width: 100%;
    max-width: 1100px;
    margin: 0 auto;
    overflow: hidden;          /* critical: prevents inner scrollbars */
    border-radius: 14px;
    background: #fff;
  }
  #africaSvg{
    display:block;
    width:100%;
    height:100%;
  }

  .country{
    fill: rgba(0,0,0,0.08);
    stroke: rgba(0,0,0,0.10);
    stroke-width: 0.7;
    vector-effect: non-scaling-stroke;
  }
  .country.has-data{ fill: rgba(255,198,39,0.60); cursor:pointer; }
  .country.has-data.hover{ fill: rgba(255,198,39,0.80); }
  .country.has-data.active{ fill: rgba(140,29,64,0.75); }

  /* no-data countries: NOT clickable */
  .country.no-data{ pointer-events:none; opacity:0.7; }

  /* Card inside same container */
  #africaCard{
    position:absolute;
    display:none;
    width: 320px;
    max-width: calc(100% - 20px);
    background:#111;
    color:#fff;
    border:1px solid rgba(255,255,255,0.18);
    border-radius: 12px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    padding: 12px;
    z-index: 5;
  }
  .cardHead{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    margin-bottom: 8px;
  }
  #africaCardTitle{ font-weight: 700; font-size: 15px; }
  #africaCardClose{
    width:30px; height:30px;
    border:none; border-radius:10px;
    background: rgba(255,255,255,0.10);
    color:#fff; cursor:pointer;
    font-size:18px; line-height:1;
  }
  #africaCardClose:hover{ background: rgba(255,255,255,0.16); }

  .cardGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .stat{
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 10px;
    padding: 8px;
  }
  .lbl{ font-size: 11px; opacity: 0.75; margin-bottom: 3px; }
  .val{ font-size: 13px; font-weight: 700; }
</style>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
(() => {
  const geoUrl = "https://raw.githubusercontent.com/LiaScript/GeoJson/master/africa.geo.json";

  // Replace with your real dataset (ISO_A3 keys)
  const stats = {
    "NGA": { country: "Nigeria", population: "223,804,632", projected2050: "401,000,000", universities: 170, youth_pct: "60%" },
    "EGY": { country: "Egypt", population: "104,258,327", projected2050: "151,000,000", universities: 120, youth_pct: "50%" },
    "ZAF": { country: "South Africa", population: "60,041,994", projected2050: "67,000,000", universities: 125, youth_pct: "43%" }
  };

  const root = document.getElementById("africaMap");
  const svg = d3.select("#africaSvg");
  const card = document.getElementById("africaCard");
  const closeBtn = document.getElementById("africaCardClose");

  const cardTitle = document.getElementById("africaCardTitle");
  const popVal = document.getElementById("popVal");
  const projVal = document.getElementById("projVal");
  const uniVal  = document.getElementById("uniVal");
  const youthVal= document.getElementById("youthVal");

  const widthBase = 900, heightBase = 900;

  const projection = d3.geoMercator();
  const path = d3.geoPath(projection);

  let countriesGroup = null;

  // zoom purely transforms a <g> (fast)
  const zoomBehavior = d3.zoom()
    .scaleExtent([1, 8])
    .translateExtent([[0, 0], [widthBase, heightBase]])
    .extent([[0, 0], [widthBase, heightBase]])
    .on("zoom", (event) => {
      if (countriesGroup) countriesGroup.attr("transform", event.transform);
    });

  svg.call(zoomBehavior);
  svg.on("dblclick.zoom", null);
  svg.on("dblclick", () => svg.transition().duration(450).call(zoomBehavior.transform, d3.zoomIdentity));

  function hideCard(){
    card.style.display = "none";
    if (countriesGroup) countriesGroup.selectAll(".country").classed("active", false);
  }
  closeBtn.addEventListener("click", hideCard);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") hideCard(); });

  // Click outside card (inside same block) closes it
  root.addEventListener("click", (e) => {
    if (card.style.display === "none") return;
    if (!card.contains(e.target)) hideCard();
  });

  function resizeToContainer(){
    const w = Math.max(320, root.getBoundingClientRect().width);
    const h = (w * heightBase) / widthBase;
    root.style.height = h + "px";
    svg.style("height", "100%");
  }

  function showCardAt(clientX, clientY){
    card.style.display = "block";
    const r = root.getBoundingClientRect();

    // Convert viewport coords -> container coords
    let left = (clientX - r.left) + 12;
    let top  = (clientY - r.top) + 12;

    // clamp within container
    const cr = card.getBoundingClientRect();
    const maxLeft = r.width - cr.width - 10;
    const maxTop  = r.height - cr.height - 10;

    if (left > maxLeft) left = Math.max(10, maxLeft);
    if (top  > maxTop)  top  = Math.max(10, maxTop);
    if (left < 10) left = 10;
    if (top  < 10) top  = 10;

    card.style.left = left + "px";
    card.style.top  = top  + "px";
  }

  d3.json(geoUrl).then(geo => {
    svg
      .attr("viewBox", `0 0 ${widthBase} ${heightBase}`)
      .attr("preserveAspectRatio", "xMidYMid meet");

    projection.fitExtent([[22,22],[widthBase-22,heightBase-22]], geo);

    countriesGroup = svg.append("g").attr("class", "countries");

    const features = geo.features.map(f => {
      const p = f.properties || {};
      const iso = p.ISO_A3 || p.iso_a3 || p.ID || "";
      const name = p.ADMIN || p.name || iso;
      const hasData = !!stats[iso];
      f.__iso = iso; f.__name = name; f.__hasData = hasData;
      return f;
    });

    countriesGroup.selectAll("path")
      .data(features)
      .join("path")
        .attr("class", d => d.__hasData ? "country has-data" : "country no-data")
        .attr("d", path)
        .on("mouseover", function(_, d){
          if (!d.__hasData) return;
          d3.select(this).classed("hover", true);
        })
        .on("mouseout", function(_, d){
          if (!d.__hasData) return;
          d3.select(this).classed("hover", false);
        })
        .on("click", function(event, d){
          if (!d.__hasData) return;     // not clickable
          event.stopPropagation();

          countriesGroup.selectAll(".country").classed("active", false);
          d3.select(this).classed("active", true);

          const data = stats[d.__iso];
          cardTitle.textContent = data.country || d.__name;
          popVal.textContent = data.population ?? "N/A";
          projVal.textContent = data.projected2050 ?? "N/A";
          uniVal.textContent = data.universities ?? "N/A";
          youthVal.textContent = data.youth_pct ?? "N/A";

          showCardAt(event.clientX, event.clientY);
        });

    // Embed-safe resize (works even when Drupal changes widths without window resize)
    const ro = new ResizeObserver(resizeToContainer);
    ro.observe(root);
    requestAnimationFrame(resizeToContainer);
    setTimeout(resizeToContainer, 150);
  }).catch(console.error);
})();
</script>
